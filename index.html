<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pharma & Biotech News Aggregator</title>
<style>
    :root {
        --bg: #121212;
        --text: #e0e0e0;
        --link: #90caf9;
        --border: #333;
        --header-bg: #1e1e1e;
        --hover-bg: #2a2a2a;
        --accent: #4a90e2;
    }

    body {
        font-family: 'Segoe UI', Arial, sans-serif;
        margin: 0;
        padding: 10px;
        background: var(--bg);
        color: var(--text);
        line-height: 1.4;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    header {
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border);
    }

    h1 {
        margin: 0 0 8px 0;
        color: #fff;
        font-weight: 600;
        font-size: 1.8rem;
    }

    .status-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
        color: #aaa;
        margin-bottom: 10px;
    }

    .last-updated {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .refresh-indicator {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .refresh-indicator::before {
        content: "";
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background-color: #4CAF50;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }

    .controls {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
    }

    #search {
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 4px;
        background: var(--header-bg);
        color: var(--text);
        width: 200px;
        font-size: 13px;
    }

    #sourceFilter {
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 4px;
        background: var(--header-bg);
        color: var(--text);
        font-size: 13px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 5px;
    }

    th, td {
        padding: 8px 10px;
        border-bottom: 1px solid var(--border);
        text-align: left;
    }

    th {
        background-color: var(--header-bg);
        font-weight: 600;
        position: sticky;
        top: 0;
        font-size: 13px;
    }

    tr:hover {
        background-color: var(--hover-bg);
    }

    a {
        color: var(--link);
        text-decoration: none;
        transition: color 0.2s;
        font-size: 13px;
    }

    a:hover {
        color: #bbdefb;
        text-decoration: underline;
    }

    .loading-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        flex-direction: column;
        gap: 10px;
    }

    .spinner {
        width: 30px;
        height: 30px;
        border: 3px solid rgba(255, 255, 255, 0.1);
        border-left-color: var(--accent);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .error {
        color: #f44336;
        padding: 8px 12px;
        background-color: rgba(244, 67, 54, 0.1);
        border-radius: 4px;
        margin: 8px 0;
        font-size: 13px;
    }

    .no-results {
        text-align: center;
        padding: 20px;
        font-style: italic;
        color: #aaa;
        font-size: 13px;
    }

    .load-more {
        text-align: center;
        margin: 15px 0;
    }

    .load-more-btn {
        padding: 8px 16px;
        background-color: var(--accent);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        transition: background-color 0.2s;
    }

    .load-more-btn:hover {
        background-color: #3a7bd5;
    }

    .load-more-btn:disabled {
        background-color: #666;
        cursor: not-allowed;
    }

    .source-badge {
        display: inline-block;
        padding: 3px 6px;
        border-radius: 3px;
        font-size: 11px;
        font-weight: 600;
        background-color: #333;
        color: #ddd;
    }

    .scroll-indicator {
        text-align: center;
        padding: 10px;
        font-size: 13px;
        color: #aaa;
    }

    @media (max-width: 768px) {
        body {
            padding: 8px;
        }
        
        .controls {
            flex-direction: column;
            gap: 8px;
        }
        
        #search {
            width: 100%;
        }
        
        table {
            font-size: 12px;
        }
        
        th, td {
            padding: 6px 8px;
        }
        
        .status-bar {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }
    }
</style>
</head>

<body>
<div class="container">
    <header>
        <h1>Pharma & Biotech News</h1>
        <div class="status-bar">
            <div class="last-updated">
                <span>Last updated:</span>
                <span id="lastUpdatedTime">--:--:--</span>
            </div>
            <div class="refresh-indicator">
                Auto-refresh every 5 minutes
            </div>
        </div>
    </header>

    <div class="controls">
        <input type="text" id="search" placeholder="Search articles...">
        <select id="sourceFilter">
            <option value="all">All Sources</option>
        </select>
    </div>

    <table id="newsTable">
        <thead>
            <tr>
                <th>Source</th>
                <th>Title</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    
    <div class="load-more">
        <button id="loadEarlierBtn" class="load-more-btn">Load Earlier Articles</button>
    </div>
    
    <div id="loading" class="loading-container">
        <div class="spinner"></div>
        <div>Loading latest pharma and biotech news...</div>
    </div>
    
    <div id="scrollIndicator" class="scroll-indicator" style="display: none;">
        Loading more articles...
    </div>
</div>

<script>
/* --------------------
   RSS SOURCES
-------------------- */
const feeds = [
    { 
        name: "BioSpace", 
        url: "https://www.biospace.com/index.rss" 
    },
    { 
        name: "Pharma Executive", 
        url: "https://www.pharmexec.com/rss" 
    },
    { 
        name: "PhRMA", 
        url: "https://www.phrma.org/rss" 
    }
];

/* --------------------
   STATE MANAGEMENT
-------------------- */
let allItems = [];
let filteredItems = [];
let shown = 0;
const batchSize = 20;
let isLoading = false;
let lastUpdated = null;
let refreshInterval;
let isFetchingEarlier = false;
let currentPage = 1;
const itemsPerPage = 50;

/* --------------------
   CACHING
-------------------- */
function getCachedFeeds() {
    const cached = localStorage.getItem('cachedFeeds');
    const timestamp = localStorage.getItem('cacheTimestamp');
    
    // Cache valid for 30 minutes
    if (cached && timestamp && (Date.now() - parseInt(timestamp)) < 30 * 60 * 1000) {
        return JSON.parse(cached);
    }
    return null;
}

function setCachedFeeds(data) {
    localStorage.setItem('cachedFeeds', JSON.stringify(data));
    localStorage.setItem('cacheTimestamp', Date.now().toString());
}

/* --------------------
   LOAD ALL FEEDS
-------------------- */
async function loadFeeds() {
    const cached = getCachedFeeds();
    if (cached) {
        allItems = cached;
        processItems();
        // Still refresh in background
        refreshFeeds();
        return;
    }

    await refreshFeeds();
}

async function refreshFeeds() {
    isLoading = true;
    updateLoadingState();
    
    // Clear previous items
    allItems = [];
    
    const feedPromises = feeds.map(feed => loadSingleFeed(feed));
    await Promise.allSettled(feedPromises);
    
    // Sort by date (newest first)
    allItems.sort((a, b) => b.date - a.date);
    
    // Cache the results
    setCachedFeeds(allItems);
    
    // Update timestamp
    lastUpdated = new Date();
    updateLastUpdatedTime();
    
    isLoading = false;
    processItems();
}

async function loadSingleFeed(feed) {
    try {
        // Try different proxy approach if one fails
        const proxyUrls = [
            `https://api.allorigins.win/get?url=${encodeURIComponent(feed.url)}`,
            `https://corsproxy.io/?${encodeURIComponent(feed.url)}`
        ];
        
        let data;
        for (const proxyUrl of proxyUrls) {
            try {
                const res = await fetch(proxyUrl);
                if (res.ok) {
                    data = await res.json();
                    break;
                }
            } catch (e) {
                console.log(`Proxy ${proxyUrl} failed for ${feed.name}`);
            }
        }
        
        if (!data) {
            throw new Error(`All proxies failed for ${feed.name}`);
        }
        
        const parser = new DOMParser();
        const xmlText = data.contents || data;
        const xml = parser.parseFromString(xmlText, "text/xml");

        // Check for parsing errors
        if (xml.querySelector('parsererror')) {
            throw new Error('XML parsing error');
        }

        // Handle different RSS formats
        let items = xml.querySelectorAll("item");
        if (items.length === 0) {
            items = xml.querySelectorAll("entry"); // For Atom feeds
        }
        
        // Handle RDF format for Nature
        if (items.length === 0) {
            items = xml.querySelectorAll("item"); // For RDF feeds
        }

        const entries = [...items].map(item => {
            const title = item.querySelector("title")?.textContent || "Untitled";
            const link = item.querySelector("link")?.textContent || 
                        item.querySelector("link")?.getAttribute("href") || 
                        item.getAttribute("rdf:about") || "#";
            
            // Handle different date formats
            let dateText = item.querySelector("pubDate")?.textContent || 
                          item.querySelector("published")?.textContent ||
                          item.querySelector("date")?.textContent ||
                          item.querySelector("dc\\:date")?.textContent ||
                          new Date().toISOString();
            
            return {
                source: feed.name,
                title: clean(title),
                link: clean(link),
                date: new Date(dateText)
            };
        });

        allItems.push(...entries);
        
    } catch (e) {
        console.error(`Failed to load ${feed.name}:`, e);
        showError(`Failed to load ${feed.name}`);
    }
}

/* --------------------
   UI UPDATES
-------------------- */
function updateLoadingState() {
    const loadingEl = document.getElementById('loading');
    if (isLoading) {
        loadingEl.style.display = 'flex';
    } else {
        loadingEl.style.display = 'none';
    }
}

function updateLastUpdatedTime() {
    const timeEl = document.getElementById('lastUpdatedTime');
    if (lastUpdated) {
        timeEl.textContent = lastUpdated.toLocaleTimeString();
    }
}

function showError(message) {
    const errorEl = document.createElement('div');
    errorEl.className = 'error';
    errorEl.textContent = message;
    document.querySelector('.container').insertBefore(errorEl, document.getElementById('newsTable'));
    
    // Remove after 5 seconds
    setTimeout(() => {
        if (errorEl.parentNode) {
            errorEl.remove();
        }
    }, 5000);
}

/* --------------------
   PROCESS AND DISPLAY ITEMS
-------------------- */
function processItems() {
    // Update source filter dropdown
    updateSourceFilter();
    
    // Apply current filters
    applyFilters();
    
    // Reset shown counter
    shown = 0;
    
    // Clear table
    document.querySelector("#newsTable tbody").innerHTML = '';
    
    // Show initial batch
    showMore();
    
    // Update loading state
    updateLoadingState();
}

function updateSourceFilter() {
    const sourceFilter = document.getElementById('sourceFilter');
    
    // Clear existing options except "All Sources"
    while (sourceFilter.children.length > 1) {
        sourceFilter.removeChild(sourceFilter.lastChild);
    }
    
    // Get unique sources
    const sources = [...new Set(allItems.map(item => item.source))];
    
    // Add source options
    sources.forEach(source => {
        const option = document.createElement('option');
        option.value = source;
        option.textContent = source;
        sourceFilter.appendChild(option);
    });
}

function applyFilters() {
    const searchTerm = document.getElementById('search').value.toLowerCase();
    const sourceFilter = document.getElementById('sourceFilter').value;
    
    filteredItems = allItems.filter(item => {
        const matchesSearch = item.title.toLowerCase().includes(searchTerm);
        const matchesSource = sourceFilter === 'all' || item.source === sourceFilter;
        
        return matchesSearch && matchesSource;
    });
    
    // Show no results message if needed
    const tbody = document.querySelector("#newsTable tbody");
    const noResults = document.querySelector('.no-results');
    
    if (noResults) noResults.remove();
    
    if (filteredItems.length === 0 && !isLoading) {
        const noResultsEl = document.createElement('div');
        noResultsEl.className = 'no-results';
        noResultsEl.textContent = 'No articles match your search criteria.';
        tbody.parentNode.insertBefore(noResultsEl, tbody.nextSibling);
    }
}

/* --------------------
   CLEAN TITLES
-------------------- */
function clean(t) {
    if (!t) return "";
    
    return t
        .replace(/<!\[CDATA\[/g, "")
        .replace(/\]\]>/g, "")
        .replace(/&lt;/g, "<")
        .replace(/&gt;/g, ">")
        .replace(/&amp;/g, "&")
        .replace(/&quot;/g, '"')
        .replace(/&apos;/g, "'")
        .replace(/&#(\d+);/g, (match, dec) => String.fromCharCode(dec))
        .trim();
}

/* --------------------
   RENDER ITEMS
-------------------- */
function showMore() {
    const tbody = document.querySelector("#newsTable tbody");
    const loadEarlierBtn = document.getElementById('loadEarlierBtn');
    
    for (let i = shown; i < shown + batchSize && i < filteredItems.length; i++) {
        const row = filteredItems[i];
        const tr = document.createElement("tr");
        
        // Format date
        const formattedDate = formatDate(row.date);
        
        tr.innerHTML = `
            <td><span class="source-badge">${row.source}</span></td>
            <td><a href="${row.link}" target="_blank">${row.title}</a></td>
            <td>${formattedDate}</td>
        `;
        tbody.appendChild(tr);
    }
    shown += batchSize;
    
    // Show/hide load earlier button
    if (shown >= filteredItems.length) {
        loadEarlierBtn.style.display = 'none';
    } else {
        loadEarlierBtn.style.display = 'inline-block';
    }
}

function formatDate(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / (1000 * 60));
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    
    if (diffMins < 60) {
        return `${diffMins} min ago`;
    } else if (diffHours < 24) {
        return `${diffHours} hr ago`;
    } else if (diffDays === 1) {
        return 'Yesterday';
    } else if (diffDays < 7) {
        return `${diffDays} days ago`;
    } else {
        return date.toLocaleDateString();
    }
}

/* --------------------
   INFINITE SCROLL
-------------------- */
function setupInfiniteScroll() {
    window.addEventListener('scroll', () => {
        // Check if we're near the bottom of the page
        if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500) {
            loadMoreOnScroll();
        }
    });
}

async function loadMoreOnScroll() {
    // Don't trigger if we're already loading or if there's nothing more to load
    if (isFetchingEarlier || shown >= filteredItems.length) return;
    
    isFetchingEarlier = true;
    
    // Show loading indicator
    const scrollIndicator = document.getElementById('scrollIndicator');
    scrollIndicator.style.display = 'block';
    
    // Simulate loading delay for better UX
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // Load more items
    showMore();
    
    // Hide loading indicator
    scrollIndicator.style.display = 'none';
    isFetchingEarlier = false;
}

/* --------------------
   LOAD EARLIER ARTICLES
-------------------- */
async function loadEarlierArticles() {
    // Don't trigger if we're already loading or if there's nothing more to load
    if (isFetchingEarlier || shown >= filteredItems.length) return;
    
    isFetchingEarlier = true;
    
    // Disable button while loading
    const loadEarlierBtn = document.getElementById('loadEarlierBtn');
    loadEarlierBtn.disabled = true;
    loadEarlierBtn.textContent = 'Loading...';
    
    // Simulate loading delay for better UX
    await new Promise(resolve => setTimeout(resolve, 800));
    
    // Load more items
    showMore();
    
    // Re-enable button
    loadEarlierBtn.disabled = false;
    loadEarlierBtn.textContent = 'Load Earlier Articles';
    isFetchingEarlier = false;
}

/* --------------------
   EVENT LISTENERS
-------------------- */
document.getElementById('search').addEventListener('input', () => {
    processItems();
});

document.getElementById('sourceFilter').addEventListener('change', () => {
    processItems();
});

document.getElementById('loadEarlierBtn').addEventListener('click', () => {
    loadEarlierArticles();
});

// Initialize
loadFeeds();
setupInfiniteScroll();

// Auto-refresh every 5 minutes
refreshInterval = setInterval(() => {
    refreshFeeds();
}, 5 * 60 * 1000);
</script>

</body>
</html>
