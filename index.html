<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pharma & Biotech News Aggregator</title>
<style>
    :root {
        --bg: #121212;
        --text: #e0e0e0;
        --link: #90caf9;
        --border: #333;
        --header-bg: #1e1e1e;
        --hover-bg: #2a2a2a;
        --accent: #4a90e2;
        --success: #4CAF50;
        --warning: #ff9800;
        --error: #f44336;
    }

    body {
        font-family: 'Segoe UI', Arial, sans-serif;
        margin: 0;
        padding: 10px;
        background: var(--bg);
        color: var(--text);
        line-height: 1.4;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    header {
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border);
    }

    h1 {
        margin: 0 0 8px 0;
        color: #fff;
        font-weight: 600;
        font-size: 1.8rem;
    }

    .status-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
        color: #aaa;
        margin-bottom: 10px;
    }

    .last-updated {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .refresh-indicator {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .refresh-indicator::before {
        content: "";
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background-color: #4CAF50;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }

    .controls {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
    }

    #search {
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 4px;
        background: var(--header-bg);
        color: var(--text);
        width: 200px;
        font-size: 13px;
    }

    #sourceFilter {
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 4px;
        background: var(--header-bg);
        color: var(--text);
        font-size: 13px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 5px;
    }

    th, td {
        padding: 8px 10px;
        border-bottom: 1px solid var(--border);
        text-align: left;
    }

    th {
        background-color: var(--header-bg);
        font-weight: 600;
        position: sticky;
        top: 0;
        font-size: 13px;
    }

    tr:hover {
        background-color: var(--hover-bg);
    }

    a {
        color: var(--link);
        text-decoration: none;
        transition: color 0.2s;
        font-size: 13px;
    }

    a:hover {
        color: #bbdefb;
        text-decoration: underline;
    }

    .loading-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        flex-direction: column;
        gap: 10px;
    }

    .spinner {
        width: 30px;
        height: 30px;
        border: 3px solid rgba(255, 255, 255, 0.1);
        border-left-color: var(--accent);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .error {
        color: var(--error);
        padding: 8px 12px;
        background-color: rgba(244, 67, 54, 0.1);
        border-radius: 4px;
        margin: 8px 0;
        font-size: 13px;
    }

    .success {
        color: var(--success);
        padding: 8px 12px;
        background-color: rgba(76, 175, 80, 0.1);
        border-radius: 4px;
        margin: 8px 0;
        font-size: 13px;
    }

    .no-results {
        text-align: center;
        padding: 20px;
        font-style: italic;
        color: #aaa;
        font-size: 13px;
    }

    .load-more {
        text-align: center;
        margin: 15px 0;
    }

    .load-more-btn {
        padding: 8px 16px;
        background-color: var(--accent);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        transition: background-color 0.2s;
    }

    .load-more-btn:hover {
        background-color: #3a7bd5;
    }

    .load-more-btn:disabled {
        background-color: #666;
        cursor: not-allowed;
    }

    .source-badge {
        display: inline-block;
        padding: 3px 6px;
        border-radius: 3px;
        font-size: 11px;
        font-weight: 600;
        background-color: #333;
        color: #ddd;
    }

    .scroll-indicator {
        text-align: center;
        padding: 10px;
        font-size: 13px;
        color: #aaa;
    }

    .feed-status {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 10px;
        font-size: 12px;
    }

    .status-item {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 4px 8px;
        border-radius: 12px;
        background: var(--header-bg);
    }

    .status-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
    }

    .status-loading { background: var(--warning); }
    .status-success { background: var(--success); }
    .status-error { background: var(--error); }

    @media (max-width: 768px) {
        body {
            padding: 8px;
        }
        
        .controls {
            flex-direction: column;
            gap: 8px;
        }
        
        #search {
            width: 100%;
        }
        
        table {
            font-size: 12px;
        }
        
        th, td {
            padding: 6px 8px;
        }
        
        .status-bar {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }
        
        .feed-status {
            flex-direction: column;
        }
    }
</style>
</head>

<body>
<div class="container">
    <header>
        <h1>Pharma & Biotech News</h1>
        <div class="status-bar">
            <div class="last-updated">
                <span>Last updated:</span>
                <span id="lastUpdatedTime">--:--:--</span>
            </div>
            <div class="refresh-indicator">
                Auto-refresh every 5 minutes
            </div>
        </div>
    </header>

    <div id="feedStatus" class="feed-status"></div>

    <div class="controls">
        <input type="text" id="search" placeholder="Search articles...">
        <select id="sourceFilter">
            <option value="all">All Sources</option>
        </select>
    </div>

    <table id="newsTable">
        <thead>
            <tr>
                <th>Source</th>
                <th>Title</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    
    <div class="load-more">
        <button id="loadEarlierBtn" class="load-more-btn" style="display: none;">Load Earlier Articles</button>
    </div>
    
    <div id="loading" class="loading-container">
        <div class="spinner"></div>
        <div>Loading latest pharma and biotech news...</div>
    </div>
    
    <div id="scrollIndicator" class="scroll-indicator" style="display: none;">
        Loading more articles...
    </div>
</div>

<script>
/* --------------------
   RSS SOURCES
-------------------- */
const feeds = [
    { 
        name: "BioSpace", 
        url: "https://www.biospace.com/index.rss" 
    },
    { 
        name: "Pharma Executive", 
        url: "https://www.pharmexec.com/rss" 
    },
    { 
        name: "BioPharma Dive", 
        url: "https://www.biopharmadive.com/feeds/news/" 
    },
    { 
        name: "Nature Reviews Drug Discovery", 
        url: "https://www.nature.com/nrd.rss" 
    }
];

/* --------------------
   STATE MANAGEMENT
-------------------- */
let allItems = [];
let filteredItems = [];
let shown = 0;
const batchSize = 20;
let isLoading = false;
let lastUpdated = null;
let refreshInterval;
let isFetchingEarlier = false;
let feedStatus = {};

/* --------------------
   CACHING
-------------------- */
function getCachedFeeds() {
    const cached = localStorage.getItem('cachedFeeds');
    const timestamp = localStorage.getItem('cacheTimestamp');
    
    // Cache valid for 30 minutes
    if (cached && timestamp && (Date.now() - parseInt(timestamp)) < 30 * 60 * 1000) {
        return JSON.parse(cached);
    }
    return null;
}

function setCachedFeeds(data) {
    localStorage.setItem('cachedFeeds', JSON.stringify(data));
    localStorage.setItem('cacheTimestamp', Date.now().toString());
}

/* --------------------
   UTILITY FUNCTIONS
-------------------- */
function timeout(ms, promise) {
    return new Promise((resolve, reject) => {
        const timer = setTimeout(() => {
            reject(new Error(`Request timed out after ${ms}ms`));
        }, ms);

        promise
            .then(value => {
                clearTimeout(timer);
                resolve(value);
            })
            .catch(reason => {
                clearTimeout(timer);
                reject(reason);
            });
    });
}

function updateFeedStatus(feedName, status, message = '') {
    feedStatus[feedName] = { status, message };
    renderFeedStatus();
}

function renderFeedStatus() {
    const container = document.getElementById('feedStatus');
    container.innerHTML = '';
    
    Object.entries(feedStatus).forEach(([name, status]) => {
        const item = document.createElement('div');
        item.className = 'status-item';
        
        const dot = document.createElement('div');
        dot.className = `status-dot status-${status.status}`;
        
        const text = document.createElement('span');
        text.textContent = name;
        
        item.appendChild(dot);
        item.appendChild(text);
        container.appendChild(item);
    });
}

/* --------------------
   LOAD ALL FEEDS
-------------------- */
async function loadFeeds() {
    const cached = getCachedFeeds();
    if (cached && cached.length > 0) {
        allItems = cached;
        processItems();
        showSuccess('Loaded from cache');
        // Refresh in background
        setTimeout(refreshFeeds, 1000);
        return;
    }

    await refreshFeeds();
}

async function refreshFeeds() {
    isLoading = true;
    updateLoadingState();
    
    // Reset feed status
    feeds.forEach(feed => {
        updateFeedStatus(feed.name, 'loading');
    });
    
    // Clear previous items but keep cache for fallback
    const previousItems = [...allItems];
    allItems = [];
    
    // Load feeds sequentially with delays to avoid overwhelming
    let successCount = 0;
    
    for (let i = 0; i < feeds.length; i++) {
        const feed = feeds[i];
        
        try {
            const result = await loadSingleFeed(feed);
            if (result && result.length > 0) {
                successCount++;
                updateFeedStatus(feed.name, 'success');
            } else {
                updateFeedStatus(feed.name, 'error', 'No articles found');
            }
            
            // Small delay between requests
            if (i < feeds.length - 1) {
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        } catch (error) {
            console.error(`Failed to load ${feed.name}:`, error);
            updateFeedStatus(feed.name, 'error', error.message);
        }
    }
    
    // If no feeds loaded successfully, restore from cache/previous
    if (allItems.length === 0 && previousItems.length > 0) {
        allItems = previousItems;
        showError('Using cached data - feeds unavailable');
    }
    
    // Sort by date (newest first)
    allItems.sort((a, b) => b.date - a.date);
    
    // Cache the results
    if (allItems.length > 0) {
        setCachedFeeds(allItems);
    }
    
    // Update timestamp
    lastUpdated = new Date();
    updateLastUpdatedTime();
    
    isLoading = false;
    processItems();
    
    if (successCount > 0) {
        showSuccess(`Loaded ${successCount}/${feeds.length} feeds successfully`);
    }
}

async function loadSingleFeed(feed) {
    const PROXY_TIMEOUT = 10000; // 10 seconds
    
    // Try different proxy approaches
    const proxyAttempts = [
        // Direct CORS proxy
        `https://corsproxy.io/?${encodeURIComponent(feed.url)}`,
        // Alternative proxy
        `https://api.codetabs.com/v1/proxy/?quest=${encodeURIComponent(feed.url)}`,
        // AllOrigins as fallback
        `https://api.allorigins.win/get?url=${encodeURIComponent(feed.url)}`
    ];
    
    for (const proxyUrl of proxyAttempts) {
        try {
            console.log(`Trying proxy: ${proxyUrl}`);
            const response = await timeout(PROXY_TIMEOUT, fetch(proxyUrl));
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            
            // Handle different proxy response formats
            const xmlText = data.contents || data.content || data;
            if (!xmlText) {
                throw new Error('Empty response from proxy');
            }
            
            const parser = new DOMParser();
            const xml = parser.parseFromString(xmlText, "text/xml");

            // Check for parsing errors
            if (xml.querySelector('parsererror')) {
                throw new Error('XML parsing error');
            }

            // Handle different RSS formats
            let items = xml.querySelectorAll("item");
            if (items.length === 0) {
                items = xml.querySelectorAll("entry"); // For Atom feeds
            }

            const entries = [...items].map(item => {
                const title = item.querySelector("title")?.textContent || "Untitled";
                const link = item.querySelector("link")?.textContent || 
                            item.querySelector("link")?.getAttribute("href") || 
                            "#";
                
                // Handle different date formats
                let dateText = item.querySelector("pubDate")?.textContent || 
                              item.querySelector("published")?.textContent ||
                              item.querySelector("date")?.textContent ||
                              new Date().toISOString();
                
                return {
                    source: feed.name,
                    title: clean(title),
                    link: clean(link),
                    date: new Date(dateText)
                };
            }).filter(item => item.title !== "Untitled");

            allItems.push(...entries);
            console.log(`Successfully loaded ${entries.length} articles from ${feed.name}`);
            return entries;
            
        } catch (error) {
            console.warn(`Proxy failed (${proxyUrl}):`, error.message);
            // Continue to next proxy attempt
        }
    }
    
    throw new Error('All proxy attempts failed');
}

/* --------------------
   UI UPDATES
-------------------- */
function updateLoadingState() {
    const loadingEl = document.getElementById('loading');
    if (isLoading) {
        loadingEl.style.display = 'flex';
    } else {
        loadingEl.style.display = 'none';
    }
}

function updateLastUpdatedTime() {
    const timeEl = document.getElementById('lastUpdatedTime');
    if (lastUpdated) {
        timeEl.textContent = lastUpdated.toLocaleTimeString();
    }
}

function showError(message) {
    showMessage(message, 'error');
}

function showSuccess(message) {
    showMessage(message, 'success');
}

function showMessage(message, type) {
    const messageEl = document.createElement('div');
    messageEl.className = type;
    messageEl.textContent = message;
    document.querySelector('.container').insertBefore(messageEl, document.getElementById('newsTable'));
    
    // Remove after 5 seconds
    setTimeout(() => {
        if (messageEl.parentNode) {
            messageEl.remove();
        }
    }, 5000);
}

/* --------------------
   PROCESS AND DISPLAY ITEMS
-------------------- */
function processItems() {
    // Update source filter dropdown
    updateSourceFilter();
    
    // Apply current filters
    applyFilters();
    
    // Reset shown counter
    shown = 0;
    
    // Clear table
    document.querySelector("#newsTable tbody").innerHTML = '';
    
    // Show initial batch
    showMore();
    
    // Update loading state
    updateLoadingState();
    
    // Update load earlier button visibility
    updateLoadEarlierButton();
}

function updateLoadEarlierButton() {
    const loadEarlierBtn = document.getElementById('loadEarlierBtn');
    
    // Only show the button if we have items and there are more to load
    if (filteredItems.length > batchSize && shown < filteredItems.length) {
        loadEarlierBtn.style.display = 'inline-block';
    } else {
        loadEarlierBtn.style.display = 'none';
    }
}

function updateSourceFilter() {
    const sourceFilter = document.getElementById('sourceFilter');
    
    // Clear existing options except "All Sources"
    while (sourceFilter.children.length > 1) {
        sourceFilter.removeChild(sourceFilter.lastChild);
    }
    
    // Get unique sources
    const sources = [...new Set(allItems.map(item => item.source))];
    
    // Add source options
    sources.forEach(source => {
        const option = document.createElement('option');
        option.value = source;
        option.textContent = source;
        sourceFilter.appendChild(option);
    });
}

function applyFilters() {
    const searchTerm = document.getElementById('search').value.toLowerCase();
    const sourceFilter = document.getElementById('sourceFilter').value;
    
    filteredItems = allItems.filter(item => {
        const matchesSearch = item.title.toLowerCase().includes(searchTerm);
        const matchesSource = sourceFilter === 'all' || item.source === sourceFilter;
        
        return matchesSearch && matchesSource;
    });
    
    // Show no results message if needed
    const tbody = document.querySelector("#newsTable tbody");
    const noResults = document.querySelector('.no-results');
    
    if (noResults) noResults.remove();
    
    if (filteredItems.length === 0 && !isLoading) {
        const noResultsEl = document.createElement('div');
        noResultsEl.className = 'no-results';
        noResultsEl.textContent = 'No articles match your search criteria.';
        tbody.parentNode.insertBefore(noResultsEl, tbody.nextSibling);
    }
}

/* --------------------
   CLEAN TITLES
-------------------- */
function clean(t) {
    if (!t) return "";
    
    return t
        .replace(/<!\[CDATA\[/g, "")
        .replace(/\]\]>/g, "")
        .replace(/&lt;/g, "<")
        .replace(/&gt;/g, ">")
        .replace(/&amp;/g, "&")
        .replace(/&quot;/g, '"')
        .replace(/&apos;/g, "'")
        .replace(/&#(\d+);/g, (match, dec) => String.fromCharCode(dec))
        .trim();
}

/* --------------------
   RENDER ITEMS
-------------------- */
function showMore() {
    const tbody = document.querySelector("#newsTable tbody");
    
    for (let i = shown; i < shown + batchSize && i < filteredItems.length; i++) {
        const row = filteredItems[i];
        const tr = document.createElement("tr");
        
        // Format date
        const formattedDate = formatDate(row.date);
        
        tr.innerHTML = `
            <td><span class="source-badge">${row.source}</span></td>
            <td><a href="${row.link}" target="_blank">${row.title}</a></td>
            <td>${formattedDate}</td>
        `;
        tbody.appendChild(tr);
    }
    shown += batchSize;
    
    // Update load earlier button visibility
    updateLoadEarlierButton();
}

function formatDate(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / (1000 * 60));
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    
    if (diffMins < 60) {
        return `${diffMins} min ago`;
    } else if (diffHours < 24) {
        return `${diffHours} hr ago`;
    } else if (diffDays === 1) {
        return 'Yesterday';
    } else if (diffDays < 7) {
        return `${diffDays} days ago`;
    } else {
        return date.toLocaleDateString();
    }
}

/* --------------------
   INFINITE SCROLL
-------------------- */
function setupInfiniteScroll() {
    window.addEventListener('scroll', () => {
        // Check if we're near the bottom of the page
        if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500) {
            loadMoreOnScroll();
        }
    });
}

async function loadMoreOnScroll() {
    // Don't trigger if we're already loading or if there's nothing more to load
    if (isFetchingEarlier || shown >= filteredItems.length) return;
    
    isFetchingEarlier = true;
    
    // Show loading indicator
    const scrollIndicator = document.getElementById('scrollIndicator');
    scrollIndicator.style.display = 'block';
    
    // Simulate loading delay for better UX
    await new Promise(resolve => setTimeout(resolve, 300));
    
    // Load more items
    showMore();
    
    // Hide loading indicator
    scrollIndicator.style.display = 'none';
    isFetchingEarlier = false;
}

/* --------------------
   LOAD EARLIER ARTICLES
-------------------- */
async function loadEarlierArticles() {
    // Don't trigger if we're already loading or if there's nothing more to load
    if (isFetchingEarlier || shown >= filteredItems.length) return;
    
    isFetchingEarlier = true;
    
    // Disable button while loading
    const loadEarlierBtn = document.getElementById('loadEarlierBtn');
    loadEarlierBtn.disabled = true;
    loadEarlierBtn.textContent = 'Loading...';
    
    // Simulate loading delay for better UX
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // Load more items
    showMore();
    
    // Re-enable button
    loadEarlierBtn.disabled = false;
    loadEarlierBtn.textContent = 'Load Earlier Articles';
    isFetchingEarlier = false;
}

/* --------------------
   EVENT LISTENERS
-------------------- */
document.getElementById('search').addEventListener('input', () => {
    processItems();
});

document.getElementById('sourceFilter').addEventListener('change', () => {
    processItems();
});

document.getElementById('loadEarlierBtn').addEventListener('click', () => {
    loadEarlierArticles();
});

// Initialize
loadFeeds();
setupInfiniteScroll();

// Auto-refresh every 5 minutes
refreshInterval = setInterval(() => {
    refreshFeeds();
}, 5 * 60 * 1000);
</script>

</body>
</html>
