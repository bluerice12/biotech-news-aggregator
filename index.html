<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Minimal Pharma News Aggregator</title>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: var(--bg);
        color: var(--text);
        transition: 0.3s;
    }
    h1 { margin-bottom: 15px; }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    th, td {
        padding: 8px;
        border-bottom: 1px solid var(--border);
    }
    a { color: var(--link); }
    #toggleDark {
        padding: 6px 12px;
        margin-bottom: 15px;
        cursor: pointer;
    }
</style>
</head>

<body>

<h1>Pharma & Biotech News</h1>
<button id="toggleDark">Toggle Dark Mode</button>

<table id="newsTable">
    <thead>
        <tr>
            <th>Source</th>
            <th>Title</th>
            <th>Date</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
/* --------------------
   DARK MODE
-------------------- */
const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
let dark = prefersDark;

function applyTheme() {
    if (dark) {
        document.documentElement.style.setProperty("--bg", "#121212");
        document.documentElement.style.setProperty("--text", "#e0e0e0");
        document.documentElement.style.setProperty("--link", "#90caf9");
        document.documentElement.style.setProperty("--border", "#333");
    } else {
        document.documentElement.style.setProperty("--bg", "#ffffff");
        document.documentElement.style.setProperty("--text", "#000000");
        document.documentElement.style.setProperty("--link", "#0066cc");
        document.documentElement.style.setProperty("--border", "#ccc");
    }
}
document.getElementById("toggleDark").onclick = () => { dark = !dark; applyTheme(); };
applyTheme();

/* --------------------
   RSS SOURCES
-------------------- */
const feeds = [
    { name: "FiercePharma", url: "https://www.fiercepharma.com/rss.xml" },
    { name: "FierceBiotech", url: "https://www.fiercebiotech.com/rss.xml" },
    { name: "BioSpace", url: "https://www.biospace.com/rss/breaking-news" },
    { name: "Pharma Executive", url: "https://www.pharmexec.com/rss" },
    { name: "PhRMA", url: "https://www.phrma.org/rss" }
];

/* Better proxy because rss2json fails often */
function proxy(url) {
    return `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
}

let allItems = [];
let shown = 0;
const batchSize = 20;

/* --------------------
   LOAD ALL FEEDS
-------------------- */
async function loadFeeds() {
    for (const f of feeds) {
        try {
            const res = await fetch(proxy(f.url));
            const data = await res.json();
            const parser = new DOMParser();
            const xml = parser.parseFromString(data.contents, "text/xml");

            const entries = [...xml.querySelectorAll("item")].map(item => ({
                source: f.name,
                title: clean(item.querySelector("title")?.textContent || "Untitled"),
                link: item.querySelector("link")?.textContent,
                date: new Date(item.querySelector("pubDate")?.textContent)
            }));

            allItems.push(...entries);

        } catch (e) {
            console.log("Failed:", f.name, e);
        }
    }

    allItems.sort((a, b) => b.date - a.date);
    showMore();
}

/* --------------------
   CLEAN TITLES
-------------------- */
function clean(t) {
    return t
        .replace(/<!\[CDATA\[/g, "")
        .replace(/\]\]>/g, "")
        .replace(/&lt;/g, "<")
        .replace(/&gt;/g, ">")
        .replace(/&amp;/g, "&")
        .trim();
}

/* --------------------
   RENDER 20 ITEMS AT A TIME
-------------------- */
function showMore() {
    const tbody = document.querySelector("#newsTable tbody");
    for (let i = shown; i < shown + batchSize && i < allItems.length; i++) {
        const row = allItems[i];
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${row.source}</td>
            <td><a href="${row.link}" target="_blank">${row.title}</a></td>
            <td>${row.date.toLocaleString()}</td>
        `;
        tbody.appendChild(tr);
    }
    shown += batchSize;
}

/* --------------------
   INFINITE SCROLL
-------------------- */
window.addEventListener("scroll", () => {
    if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 200) {
        showMore();
    }
});

loadFeeds();
</script>

</body>
</html>
