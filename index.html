<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pharma & Biotech News Aggregator</title>
<style>
:root {
    --bg: #121212;
    --text: #e0e0e0;
    --link: #90caf9;
    --border: #333;
    --header-bg: #1e1e1e;
    --hover-bg: #2a2a2a;
    --accent: #4a90e2;
    --success: #4CAF50;
    --warning: #ff9800;
    --error: #f44336;
}

body {
    font-family: 'Segoe UI', Arial, sans-serif;
    margin: 0;
    padding: 10px;
    background: var(--bg);
    color: var(--text);
    line-height: 1.4;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
}

header {
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border);
}

h1 {
    margin: 0 0 8px 0;
    color: #fff;
    font-weight: 600;
    font-size: 1.8rem;
}

.status-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 13px;
    color: #aaa;
    margin-bottom: 10px;
}

.controls {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}

#search {
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: 4px;
    background: var(--header-bg);
    color: var(--text);
    width: 200px;
    font-size: 13px;
}

#sourceFilter {
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: 4px;
    background: var(--header-bg);
    color: var(--text);
    font-size: 13px;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 5px;
}

th, td {
    padding: 6px 8px;
    border-bottom: 1px solid var(--border);
    text-align: left;
}

th {
    background-color: var(--header-bg);
    font-weight: 600;
    position: sticky;
    top: 0;
    font-size: 13px;
}

tr:hover {
    background-color: var(--hover-bg);
}

a {
    color: var(--link);
    text-decoration: none;
    transition: color 0.2s;
    font-size: 13px;
}

a:hover {
    color: #bbdefb;
    text-decoration: underline;
}

.loading-container {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
    flex-direction: column;
    gap: 15px;
}

.progress-container {
    width: 100%;
    max-width: 400px;
    background: var(--header-bg);
    border-radius: 10px;
    overflow: hidden;
    height: 20px;
}

.progress-bar {
    height: 100%;
    background: var(--accent);
    width: 0%;
    transition: width 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
    font-weight: bold;
}

.error {
    color: var(--error);
    padding: 8px 12px;
    background-color: rgba(244, 67, 54, 0.1);
    border-radius: 4px;
    margin: 8px 0;
    font-size: 13px;
}

.success {
    color: var(--success);
    padding: 8px 12px;
    background-color: rgba(76, 175, 80, 0.1);
    border-radius: 4px;
    margin: 8px 0;
    font-size: 13px;
}

.no-results {
    text-align: center;
    padding: 20px;
    font-style: italic;
    color: #aaa;
    font-size: 13px;
}

.load-more {
    text-align: center;
    margin: 15px 0;
}

.load-more-btn {
    padding: 8px 16px;
    background-color: var(--accent);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
    transition: background-color 0.2s;
}

.load-more-btn:hover {
    background-color: #3a7bd5;
}

.load-more-btn:disabled {
    background-color: #666;
    cursor: not-allowed;
}

.source-badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 11px;
    font-weight: 600;
    background-color: #333;
    color: #ddd;
}

.scroll-indicator {
    text-align: center;
    padding: 10px;
    font-size: 13px;
    color: #aaa;
}

.feed-status {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 10px;
    font-size: 12px;
}

.status-item {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 4px 8px;
    border-radius: 12px;
    background: var(--header-bg);
}

.status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
}

.status-loading { background: var(--warning); }
.status-success { background: var(--success); }
.status-error { background: var(--error); }

@media (max-width: 768px) {
    body { padding: 8px; }
    .controls { flex-direction: column; gap: 8px; }
    #search { width: 100%; }
    table { font-size: 12px; }
    th, td { padding: 4px 6px; }
}
</style>
</head>
<body>
<div class="container">
<header>
    <h1>Pharma & Biotech News</h1>
    <div class="status-bar">
        <div class="last-updated">
            <span>Last updated:</span>
            <span id="lastUpdatedTime">--:--:--</span>
        </div>
        <div class="refresh-indicator">
            Auto-refresh every 5 minutes
        </div>
    </div>
</header>

<div id="feedStatus" class="feed-status"></div>

<div class="controls">
    <input type="text" id="search" placeholder="Search articles...">
    <select id="sourceFilter">
        <option value="all">All Sources</option>
    </select>
</div>

<table id="newsTable">
    <thead>
        <tr>
            <th>Source</th>
            <th>Title</th>
            <th>Date</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<div class="load-more">
    <button id="loadEarlierBtn" class="load-more-btn" style="display: none;">Load Earlier Articles</button>
</div>

<div id="loading" class="loading-container">
    <div class="progress-container">
        <div id="progressBar" class="progress-bar">0%</div>
    </div>
    <div id="loadingText">Loading latest pharma and biotech news...</div>
</div>

<div id="scrollIndicator" class="scroll-indicator" style="display: none;">
    Loading more articles...
</div>
</div>

<script>
const feeds = [
    { name: "BioSpace", url: "https://www.biospace.com/index.rss" },
    { name: "Pharma Executive", url: "https://www.pharmexec.com/rss" },
    { name: "Genetic Engineering & Biotechnology News", url: "https://www.genengnews.com/feed/" },
    { name: "Fierce Biotech", url: "https://www.fiercebiotech.com/rss" },
    { name: "Fierce Pharma", url: "https://www.fiercepharma.com/rss" },
    { name: "Endpoints News", url: "https://endpts.com/feed/" }
];

let allItems = [];
let filteredItems = [];
let shown = 0;
const batchSize = 25;
let isLoading = false;
let lastUpdated = null;
let feedStatusObj = {};
let isFetchingMore = false;

/* -------------------- UTILITIES -------------------- */
function clean(t) {
    if (!t) return "";
    return t.replace(/<!\[CDATA\[/g,"").replace(/\]\]>/g,"")
            .replace(/&lt;/g,"<").replace(/&gt;/g,">")
            .replace(/&amp;/g,"&").replace(/&quot;/g,'"')
            .replace(/&apos;/g,"'").replace(/&#(\d+);/g,(m,d)=>String.fromCharCode(d))
            .trim();
}

function formatDate(date){
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs/60000);
    const diffHours = Math.floor(diffMs/3600000);
    const diffDays = Math.floor(diffMs/86400000);
    if(diffMins<60) return diffMins+'m ago';
    else if(diffHours<24) return diffHours+'h ago';
    else if(diffDays===1) return 'Yesterday';
    else if(diffDays<7) return diffDays+'d ago';
    else return date.toLocaleDateString();
}

function updateProgress(percent,text){
    const bar = document.getElementById('progressBar');
    const txt = document.getElementById('loadingText');
    bar.style.width = percent+'%';
    bar.textContent = Math.round(percent)+'%';
    if(text) txt.textContent = text;
}

function updateLastUpdatedTime(){
    const el = document.getElementById('lastUpdatedTime');
    if(lastUpdated) el.textContent = lastUpdated.toLocaleTimeString();
}

function showMessage(msg,type){
    const div = document.createElement('div');
    div.className=type;
    div.textContent=msg;
    document.querySelector('.container').insertBefore(div,document.getElementById('newsTable'));
    setTimeout(()=>{ if(div.parentNode) div.remove(); },5000);
}

function updateFeedStatus(name,status){
    feedStatusObj[name]=status;
    const container = document.getElementById('feedStatus');
    container.innerHTML='';
    Object.entries(feedStatusObj).forEach(([n,s])=>{
        const item=document.createElement('div');
        item.className='status-item';
        const dot=document.createElement('div');
        dot.className='status-dot status-'+s;
        const text=document.createElement('span'); text.textContent=n;
        item.appendChild(dot); item.appendChild(text); container.appendChild(item);
    });
}

/* -------------------- FETCHING FEEDS -------------------- */
async function fetchFeed(feed){
    const cached=localStorage.getItem('feedCache_'+feed.name);
    const timestamp=localStorage.getItem('feedCacheTS_'+feed.name);
    if(cached && timestamp && (Date.now()-parseInt(timestamp))<30*60000){
        return JSON.parse(cached);
    }

    const proxy=`https://corsproxy.io/?${encodeURIComponent(feed.url)}`;
    try{
        const controller=new AbortController();
        const timeout=setTimeout(()=>controller.abort(),8000);
        const res=await fetch(proxy,{signal:controller.signal});
        clearTimeout(timeout);
        if(!res.ok) throw new Error('HTTP '+res.status);
        const text=await res.text();
        const parser=new DOMParser();
        const xml=parser.parseFromString(text,"text/xml");
        if(xml.querySelector('parsererror')) throw new Error('XML parse error');
        let items=xml.querySelectorAll('item');
        if(items.length===0) items=xml.querySelectorAll('entry');
        const entries=Array.from(items).slice(0,25).map(it=>{
            const title=it.querySelector('title')?.textContent || 'Untitled';
            const link=it.querySelector('link')?.textContent || it.querySelector('link')?.getAttribute('href') || '#';
            const dateText=it.querySelector('pubDate')?.textContent || it.querySelector('published')?.textContent || new Date().toISOString();
            return {source:feed.name,title:clean(title),link:clean(link),date:new Date(dateText)};
        }).filter(it=>it.title!=='Untitled');
        localStorage.setItem('feedCache_'+feed.name,JSON.stringify(entries));
        localStorage.setItem('feedCacheTS_'+feed.name,Date.now().toString());
        return entries;
    }catch(e){
        console.error(feed.name,e); return [];
    }
}

async function loadFeeds(){
    isLoading=true; updateLoadingState();
    updateProgress(0,'Starting feed loading...');
    const totalFeeds=feeds.length;
    let loadedFeeds=0;

    const feedPromises=feeds.map(feed=>fetchFeed(feed).then(entries=>{
        loadedFeeds++;
        updateFeedStatus(feed.name,entries.length>0?'success':'error');
        updateProgress((loadedFeeds/totalFeeds)*100,`Loaded ${feed.name}`);
        allItems.push(...entries);
        renderTableIncremental();
    }).catch(e=>{
        loadedFeeds++;
        updateFeedStatus(feed.name,'error');
        updateProgress((loadedFeeds/totalFeeds)*100,`Error loading ${feed.name}`);
    }));

    await Promise.all(feedPromises);
    allItems.sort((a,b)=>b.date-a.date);
    lastUpdated=new Date(); updateLastUpdatedTime();
    isLoading=false; updateLoadingState();
    showMessage(`Loaded ${allItems.length} articles`,'success');
    updateSourceFilter(); applyFilters();
}

/* -------------------- UI & TABLE -------------------- */
function updateLoadingState(){
    document.getElementById('loading').style.display=isLoading?'flex':'none';
}

function renderTableIncremental(){
    const tbody=document.querySelector('#newsTable tbody');
    tbody.innerHTML='';
    const batch=filteredItems.slice(0,shown+batchSize);
    batch.forEach(row=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td><span class="source-badge">${row.source}</span></td>
                      <td><a href="${row.link}" target="_blank">${row.title}</a></td>
                      <td>${formatDate(row.date)}</td>`;
        tbody.appendChild(tr);
    });
    shown=batch.length;
    updateLoadEarlierButton();
}

function updateLoadEarlierButton(){
    const btn=document.getElementById('loadEarlierBtn');
    btn.style.display=(shown<filteredItems.length)?'inline-block':'none';
}

/* -------------------- FILTERS -------------------- */
function updateSourceFilter(){
    const sel=document.getElementById('sourceFilter');
    while(sel.children.length>1) sel.removeChild(sel.lastChild);
    const sources=[...new Set(allItems.map(it=>it.source))];
    sources.forEach(s=>{
        const opt=document.createElement('option');
        opt.value=s; opt.textContent=s;
        sel.appendChild(opt);
    });
}

function applyFilters(){
    const term=document.getElementById('search').value.toLowerCase();
    const source=document.getElementById('sourceFilter').value;
    filteredItems=allItems.filter(it=>(it.title.toLowerCase().includes(term))&&(source==='all'||it.source===source));
    const tbody=document.querySelector('#newsTable tbody');
    const nores=document.querySelector('.no-results'); if(nores) nores.remove();
    if(filteredItems.length===0 && !isLoading){
        const div=document.createElement('div'); div.className='no-results';
        div.textContent='No articles match your search criteria.';
        tbody.parentNode.insertBefore(div,tbody.nextSibling);
    }
    shown=0; renderTableIncremental();
}

/* -------------------- INFINITE SCROLL -------------------- */
window.addEventListener('scroll',()=>{
    if(window.innerHeight+window.scrollY>=document.body.offsetHeight-500){
        loadMore();
    }
});

function loadMore(){
    if(isFetchingMore || shown>=filteredItems.length) return;
    isFetchingMore=true;
    const scrollInd=document.getElementById('scrollIndicator');
    scrollInd.style.display='block';
    setTimeout(()=>{
        shown=Math.min(shown+batchSize,filteredItems.length);
        renderTableIncremental();
        scrollInd.style.display='none';
        isFetchingMore=false;
    },200);
}

document.getElementById('loadEarlierBtn').addEventListener('click',loadMore);
document.getElementById('search').addEventListener('input',applyFilters);
document.getElementById('sourceFilter').addEventListener('change',applyFilters);

/* -------------------- INIT -------------------- */
loadFeeds();
// Auto-refresh every 5 minutes
setInterval(()=>loadFeeds(),5*60000);
</script>
</body>
</html>
