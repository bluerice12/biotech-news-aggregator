<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pharma & Biotech News Aggregator</title>
<style>
    :root {
        --bg: #121212;
        --text: #e0e0e0;
        --link: #90caf9;
        --border: #333;
        --header-bg: #1e1e1e;
        --hover-bg: #2a2a2a;
        --accent: #4a90e2;
        --success: #4CAF50;
        --warning: #ff9800;
        --error: #f44336;
    }

    body {
        font-family: 'Segoe UI', Arial, sans-serif;
        margin: 0;
        padding: 10px;
        background: var(--bg);
        color: var(--text);
        line-height: 1.4;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    header {
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border);
    }

    h1 {
        margin: 0 0 8px 0;
        color: #fff;
        font-weight: 600;
        font-size: 1.8rem;
    }

    .status-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
        color: #aaa;
        margin-bottom: 10px;
    }

    .last-updated {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .refresh-indicator {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .refresh-indicator::before {
        content: "";
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background-color: #4CAF50;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }

    .controls {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
    }

    #search {
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 4px;
        background: var(--header-bg);
        color: var(--text);
        width: 200px;
        font-size: 13px;
    }

    #sourceFilter {
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 4px;
        background: var(--header-bg);
        color: var(--text);
        font-size: 13px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 5px;
    }

    th, td {
        padding: 6px 8px;
        border-bottom: 1px solid var(--border);
        text-align: left;
    }

    th {
        background-color: var(--header-bg);
        font-weight: 600;
        position: sticky;
        top: 0;
        font-size: 13px;
    }

    tr:hover {
        background-color: var(--hover-bg);
    }

    a {
        color: var(--link);
        text-decoration: none;
        transition: color 0.2s;
        font-size: 13px;
    }

    a:hover {
        color: #bbdefb;
        text-decoration: underline;
    }

    .loading-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        flex-direction: column;
        gap: 15px;
    }

    .progress-container {
        width: 100%;
        max-width: 400px;
        background: var(--header-bg);
        border-radius: 10px;
        overflow: hidden;
        height: 20px;
    }

    .progress-bar {
        height: 100%;
        background: var(--accent);
        width: 0%;
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
        font-weight: bold;
    }

    .error {
        color: var(--error);
        padding: 8px 12px;
        background-color: rgba(244, 67, 54, 0.1);
        border-radius: 4px;
        margin: 8px 0;
        font-size: 13px;
    }

    .success {
        color: var(--success);
        padding: 8px 12px;
        background-color: rgba(76, 175, 80, 0.1);
        border-radius: 4px;
        margin: 8px 0;
        font-size: 13px;
    }

    .no-results {
        text-align: center;
        padding: 20px;
        font-style: italic;
        color: #aaa;
        font-size: 13px;
    }

    .load-more {
        text-align: center;
        margin: 15px 0;
    }

    .load-more-btn {
        padding: 8px 16px;
        background-color: var(--accent);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        transition: background-color 0.2s;
    }

    .load-more-btn:hover {
        background-color: #3a7bd5;
    }

    .load-more-btn:disabled {
        background-color: #666;
        cursor: not-allowed;
    }

    .source-badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 11px;
        font-weight: 600;
        background-color: #333;
        color: #ddd;
    }

    .scroll-indicator {
        text-align: center;
        padding: 10px;
        font-size: 13px;
        color: #aaa;
    }

    .feed-status {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 10px;
        font-size: 12px;
    }

    .status-item {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 4px 8px;
        border-radius: 12px;
        background: var(--header-bg);
    }

    .status-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
    }

    .status-loading { background: var(--warning); }
    .status-success { background: var(--success); }
    .status-error { background: var(--error); }

    @media (max-width: 768px) {
        body { padding: 8px; }
        .controls { flex-direction: column; gap: 8px; }
        #search { width: 100%; }
        table { font-size: 12px; }
        th, td { padding: 4px 6px; }
        .status-bar { flex-direction: column; align-items: flex-start; gap: 8px; }
        .feed-status { flex-direction: column; }
    }
</style>
</head>
<body>
<div class="container">
    <header>
        <h1>Pharma & Biotech News</h1>
        <div class="status-bar">
            <div class="last-updated">
                <span>Last updated:</span>
                <span id="lastUpdatedTime">--:--:--</span>
            </div>
            <div class="refresh-indicator">
                Auto-refresh every 5 minutes
            </div>
        </div>
    </header>

    <div id="feedStatus" class="feed-status"></div>

    <div class="controls">
        <input type="text" id="search" placeholder="Search articles...">
        <select id="sourceFilter">
            <option value="all">All Sources</option>
        </select>
    </div>

    <table id="newsTable">
        <thead>
            <tr>
                <th>Source</th>
                <th>Title</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    
    <div class="load-more">
        <button id="loadEarlierBtn" class="load-more-btn" style="display: none;">Load Earlier Articles</button>
    </div>
    
    <div id="loading" class="loading-container">
        <div class="progress-container">
            <div id="progressBar" class="progress-bar">0%</div>
        </div>
        <div id="loadingText">Loading latest pharma and biotech news...</div>
    </div>
    
    <div id="scrollIndicator" class="scroll-indicator" style="display: none;">
        Loading more articles...
    </div>
</div>

<script>
/* --------------------
   RSS SOURCES
-------------------- */
const feeds = [
    { name: "BioSpace", url: "https://www.biospace.com/index.rss" },
    { name: "Pharma Executive", url: "https://www.pharmexec.com/rss" },
    { name: "Fierce Pharma", url: "https://www.fiercepharma.com/rss.xml" },
    { name: "Fierce Biotech", url: "https://www.fiercebiotech.com/rss.xml" }
];

/* --------------------
   STATE MANAGEMENT
-------------------- */
let allItems = [];
let filteredItems = [];
let shown = 0;
const batchSize = 25;
let isLoading = false;
let lastUpdated = null;
let refreshInterval;
let isFetchingEarlier = false;
let feedStatus = {};

/* --------------------
   CACHING
-------------------- */
function getCachedFeeds() {
    const cached = localStorage.getItem('cachedFeeds');
    const timestamp = localStorage.getItem('cacheTimestamp');
    if (cached && timestamp && (Date.now() - parseInt(timestamp)) < 30 * 60 * 1000) {
        return JSON.parse(cached);
    }
    return null;
}

function setCachedFeeds(data) {
    localStorage.setItem('cachedFeeds', JSON.stringify(data));
    localStorage.setItem('cacheTimestamp', Date.now().toString());
}

/* --------------------
   UTILITY FUNCTIONS
-------------------- */
function updateProgress(percent, text) {
    const progressBar = document.getElementById('progressBar');
    const loadingText = document.getElementById('loadingText');
    progressBar.style.width = percent + '%';
    progressBar.textContent = Math.round(percent) + '%';
    if (text) loadingText.textContent = text;
}

function updateFeedStatus(feedName, status, message = '') {
    feedStatus[feedName] = { status, message };
    renderFeedStatus();
}

function renderFeedStatus() {
    const container = document.getElementById('feedStatus');
    container.innerHTML = '';
    Object.entries(feedStatus).forEach(([name, status]) => {
        const item = document.createElement('div');
        item.className = 'status-item';
        const dot = document.createElement('div');
        dot.className = `status-dot status-${status.status}`;
        const text = document.createElement('span');
        text.textContent = name;
        item.appendChild(dot);
        item.appendChild(text);
        container.appendChild(item);
    });
}

/* --------------------
   OPTIMIZED FEED LOADING
-------------------- */
async function loadFeeds() {
    const cached = getCachedFeeds();
    if (cached && cached.length > 0) {
        allItems = cached;
        processItems();
        updateProgress(100, 'Ready!');
        setTimeout(() => { refreshFeeds(); }, 1000);
        return;
    }
    await refreshFeeds();
}

async function refreshFeeds() {
    isLoading = true;
    updateLoadingState();
    updateProgress(0, 'Starting feed loading...');
    feeds.forEach(feed => updateFeedStatus(feed.name, 'loading'));
    const previousItems = [...allItems];
    allItems = [];
    let successCount = 0;
    const totalFeeds = feeds.length;
    for (let i = 0; i < totalFeeds; i++) {
        const feed = feeds[i];
        updateProgress(((i / totalFeeds) * 80) + 10, `Loading ${feed.name}...`);
        try {
            const result = await loadSingleFeed(feed);
            if (result && result.length > 0) {
                successCount++;
                updateFeedStatus(feed.name, 'success');
            } else updateFeedStatus(feed.name, 'error', 'No articles found');
        } catch (error) {
            console.error(`Failed to load ${feed.name}:`, error);
            updateFeedStatus(feed.name, 'error', error.message);
        }
        await new Promise(resolve => setTimeout(resolve, 200));
    }
    if (allItems.length === 0 && previousItems.length > 0) {
        allItems = previousItems;
        showError('Using cached data - feeds unavailable');
    }
    updateProgress(95, 'Processing articles...');
    allItems.sort((a, b) => b.date - a.date);
    if (allItems.length > 0) setCachedFeeds(allItems);
    lastUpdated = new Date();
    updateLastUpdatedTime();
    isLoading = false;
    processItems();
    updateProgress(100, 'Ready!');
    if (successCount > 0) showSuccess(`Loaded ${successCount}/${totalFeeds} feeds successfully`);
    setTimeout(() => { updateLoadingState(); }, 1000);
}

/* --------------------
   LOAD SINGLE FEED
-------------------- */
async function loadSingleFeed(feed) {
    const TIMEOUT = 10000;
    const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(feed.url)}`;
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), TIMEOUT);
        const response = await fetch(proxyUrl, { signal: controller.signal });
        clearTimeout(timeoutId);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        const xmlText = data.contents || data;
        if (!xmlText) throw new Error('Empty response from proxy');
        const parser = new DOMParser();
        const xml = parser.parseFromString(xmlText, "text/xml");
        if (xml.querySelector('parsererror')) throw new Error('XML parsing error');
        let items = xml.querySelectorAll("item");
        if (items.length === 0) items = xml.querySelectorAll("entry");
        const entries = Array.from(items).slice(0, 50).map(item => {
            const title = item.querySelector("title")?.textContent || "Untitled";
            let link = item.querySelector("link")?.textContent || "";
            if (!link) {
                const altLink = item.querySelector('link[rel="alternate"]');
                link = altLink ? altLink.getAttribute("href") : "#";
            }
            let dateText = item.querySelector("pubDate")?.textContent ||
                           item.querySelector("published")?.textContent ||
                           item.querySelector("updated")?.textContent ||
                           new Date().toISOString();
            let date = new Date(dateText);
            if (isNaN(date)) date = new Date();
            return { source: feed.name, title: clean(title), link: clean(link), date };
        }).filter(item => item.title !== "Untitled");
        allItems.push(...entries);
        return entries;
    } catch (error) {
        if (error.name === 'AbortError') throw new Error('Request timeout');
        throw error;
    }
}

/* --------------------
   UI UPDATES
-------------------- */
function updateLoadingState() {
    document.getElementById('loading').style.display = isLoading ? 'flex' : 'none';
}

function updateLastUpdatedTime() {
    const timeEl = document.getElementById('lastUpdatedTime');
    if (lastUpdated) timeEl.textContent = lastUpdated.toLocaleTimeString();
}

function showError(message) { showMessage(message, 'error'); }
function showSuccess(message) { showMessage(message, 'success'); }
function showMessage(message, type) {
    const messageEl = document.createElement('div');
    messageEl.className = type;
    messageEl.textContent = message;
    document.querySelector('.container').insertBefore(messageEl, document.getElementById('newsTable'));
    setTimeout(() => { if (messageEl.parentNode) messageEl.remove(); }, 5000);
}

/* --------------------
   PROCESS AND DISPLAY ITEMS
-------------------- */
function processItems() {
    updateSourceFilter();
    applyFilters();
    shown = 0;
    document.querySelector("#newsTable tbody").innerHTML = '';
    showMore();
    updateLoadingState();
    updateLoadEarlierButton();
}

function updateLoadEarlierButton() {
    const btn = document.getElementById('loadEarlierBtn');
    btn.style.display = (filteredItems.length > batchSize && shown < filteredItems.length) ? 'inline-block' : 'none';
}

function updateSourceFilter() {
    const filter = document.getElementById('sourceFilter');
    while (filter.children.length > 1) filter.removeChild(filter.lastChild);
    const sources = [...new Set(allItems.map(item => item.source))];
    sources.forEach(source => {
        const option = document.createElement('option');
        option.value = source;
        option.textContent = source;
        filter.appendChild(option);
    });
}

function applyFilters() {
    const searchTerm = document.getElementById('search').value.toLowerCase();
    const sourceFilter = document.getElementById('sourceFilter').value;
    filteredItems = allItems.filter(item => {
        const matchesSearch = item.title.toLowerCase().includes(searchTerm);
        const matchesSource = sourceFilter === 'all' || item.source === sourceFilter;
        return matchesSearch && matchesSource;
    });
    const tbody = document.querySelector("#newsTable tbody");
    const noResults = document.querySelector('.no-results');
    if (noResults) noResults.remove();
    if (filteredItems.length === 0 && !isLoading) {
        const noEl =
```
